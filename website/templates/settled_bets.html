{% extends "base.html" %}

{% block title %}EV Betting{% endblock %}

{% block content %}
<div class="mb-3">
    <label for="filter-bookie-settled" class="form-label">Show only bookie:</label>
    <select id="filter-bookie-settled" class="form-select" style="max-width:300px;">
        <option value="all">All</option>
    </select>
</div>

<table class="table table-striped table-bordered">
    <tr>
        <th>Date</th>
        <th>Team</th>
        <th>Bookie</th>
        <th>Type</th>
        <th>Odds</th>
        <th>EV</th>
        <th>Net</th>
        <th>Outcome</th>
    </tr>
    {% for bet in bets %}
    <tr>
        <td>{{bet.date}} </td>
        <td>{{bet.team}} </td>
        <td>{{bet.bookie}}</td>
        <td>{{bet.bet_type}}</td>
        <td>{{bet.odds}}</td>
        <td>{{bet.this_EV}}</td>
        <td>{{bet.net}}</td>
        <td class="{{bet.outcome|lower}}">{{bet.outcome}}</td>
        <td>
            <button class="btn btn-primary edit-bet-btn"
                    data-bet-id="{{ bet.bet_id }}"
                    data-odds="{{ bet.odds }}"
                    data-date="{{ bet.date }}"
                    data-amount="{{ bet.bet_amount }}"
                    data-team="{{ bet.team }}"
                    data-sport="{{ bet.sport }}"
                    data-bookie="{{ bet.bookie }}"
                    data-bet-type="{{ bet.bet_type }}"
                    data-outcome="{{ bet.outcome }}">
                Update
            </button>
        </td>
    </tr>
    {% endfor %}
    <tr>
        <th>2000-00-00</th>
        <th>NET</th>
        <th>NET</th>
        <th>NET</th>
        <th>NET</th>
        <th>EV: {{ "%.2f"|format(bets_ev)}}</th>
        <th>NET: {{ "%.2f"|format(bets_net)}}</th>
        <th>Bets Won: {{bets_won}}       Bets Lost: {{bets_lost}}</th>
    </tr>
</table>

<!-- Edit modal (same pattern as other pages) -->
<div class="modal fade" id="editBetModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editBetModalTitle">Update Bet</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editBetForm" method="POST" action="{{ url_for('edit_bet') }}">
                    <input type="hidden" name="bet_id" id="modal-bet-id">
                    <div class="mb-3">
                        <label for="modal-team" class="form-label">Team:</label>
                        <input type="text" name="team" id="modal-team" class="form-control" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="modal-sport" class="form-label">Sport:</label>
                        <input type="text" name="sport" id="modal-sport" class="form-control" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="odds" class="form-label">Edit Odds:</label>
                        <input type="number" name="odds" id="modal-odds" class="form-control" value=0>
                    </div>
                    <div class="mb-3">
                        <label for="date" class="form-label">Edit Date:</label>
                        <input type="date" name="date" id="modal-date" class="form-control" value="">
                    </div>
                    <div class="mb-3">
                        <label for="amount" class="form-label">Edit Amount:</label>
                        <input type="number" name="amount" id="modal-amount" class="form-control" step="any" value=0>
                    </div>
                    <div class="mb-3">
                        <label for="bookie" class="form-label">Edit Bookie:</label>
                        <select name="bookie" id="modal-bookie" class="form-select">
                            <option value="draftkings">draftkings</option>
                            <option value="fanduel">fanduel</option>
                            <option value="betmgm">betmgm</option>
                            <option value="betrivers">betrivers</option>
                            <option value="ballybet">ballybet</option>
                            <option value="espnbet">espnbet</option>
                            <option value="fanatics">fanatics</option>
                            <option value="williamhill_us">williamhill</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="modal-bet-type" class="form-label">Bet Type:</label>
                        <select name="bet_type" id="modal-bet-type" class="form-select mb-3">
                            <option value="Moneyline">Moneyline</option>
                            <option value="Bonus">Bonus</option>
                        </select>

                        <label class="form-label">Update Outcome:</label>
                        <div class="d-grid gap-2">
                            <button type="submit" name="outcome" value="win" class="btn btn-success">Win</button>
                            <button type="submit" name="outcome" value="loss" class="btn btn-danger">Loss</button>
                            <button type="submit" name="outcome" value="Pending" class="btn btn-secondary">Pending</button>
                            <button type="submit" name="outcome" value="cancelled" class="btn btn-warning">Cancelled</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // attach update handlers
        document.querySelectorAll('.edit-bet-btn').forEach(function(btn) {
            btn.addEventListener('click', function() {
                const betId = this.getAttribute('data-bet-id');
                const odds = this.getAttribute('data-odds');
                const date = this.getAttribute('data-date');
                const amount = this.getAttribute('data-amount');
                const bookie = this.getAttribute('data-bookie');
                const betType = this.getAttribute('data-bet-type') || 'Moneyline';
                const team = this.getAttribute('data-team');
                const sport = this.getAttribute('data-sport');

                document.getElementById('editBetModalTitle').textContent = 'Update Bet: ' + team;
                document.getElementById('modal-bet-id').value = betId;
                document.getElementById('modal-team').value = team;
                document.getElementById('modal-sport').value = sport;
                document.getElementById('modal-odds').value = odds;
                document.getElementById('modal-date').value = date;
                document.getElementById('modal-amount').value = amount;
                document.getElementById('modal-bookie').value = bookie;
                document.getElementById('modal-bet-type').value = betType;

                if (!window._editBetModalInstance) {
                    const modalEl = document.getElementById('editBetModal');
                    window._editBetModalInstance = new bootstrap.Modal(modalEl);
                }
                window._editBetModalInstance.show();
            });
        });

        // bookie filter
        const filter = document.getElementById('filter-bookie-settled');
        const table = document.querySelector('table');
        const rows = Array.from(table.querySelectorAll('tbody tr'));
        const bookies = new Set();
        rows.forEach(r => { const c = r.cells[2]; if (c) bookies.add(c.textContent.trim()); });
        Array.from(bookies).sort().forEach(b => { const o = document.createElement('option'); o.value = b; o.textContent = b; filter.appendChild(o); });
        filter.addEventListener('change', function() {
            const v = this.value;
            rows.forEach(r => { const b = r.cells[2].textContent.trim(); r.style.display = (v === 'all' || b === v) ? '' : 'none'; });
        });
    });
</script>
{%endblock%}


